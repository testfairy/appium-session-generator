"use strict";

////////////////////////////////////////////////////////////////////////////////////
// TestFairy : This is an automatically generated test case for a TestFairy session.
////////////////////////////////////////////////////////////////////////////////////

// Helpers (app agnostic)
var tester = require("./helpers/setup");
var serverConfig = require('./helpers/appium-server').local;
var interactions = require("./helpers/interactions");
var wd = require("wd");
var _ = require('underscore');
var colors = require('colors');

// Session data (app specific)
var sessionData = require('./session/sessionData.json');
sessionData.sessionUrl = '{{{ sessionUrl }}}';

// App test suite
describe((sessionData.appName + " - Android Test generated by TestFairy\n").magenta, function () {
  this.timeout(60 * 60 * 1000); // 1 hour

  var driver;

  before(function () {
    driver = wd.promiseChainRemote(serverConfig);
    require("./helpers/logging").configure(driver);

    var desired = _.clone(require("./helpers/caps").androidEmulator);
    desired.app = __dirname + "/session/app.apk";

    interactions.packageName = sessionData.packageName;
    interactions.driver = driver;

    return driver.init(desired).setImplicitWaitTimeout(5000);
  });

  after(function () {
    return driver.quit();
  });

  it("should simulate a session like ".magenta + sessionData.sessionUrl.magenta.underline, async function () {
  {{#incomplete}}
    console.log("\nTF : Tests exceed supported length, trailing actions will be truncated\n".red.underline);
  {{/incomplete}}

    // TF : TestFairy.begin(), time: 00:00
    console.log("\nTF : TestFairy.begin(), time: 00:00\n".magenta.underline);
    await interactions.begin({{{ initialDelay }}}); // EDITME : Set up an initial delay, in milis

  {{#testLines}}
  {{! ---------------------------------- }}
    {{#input}}
      {{#touchDown}}
    // TF : {{{timeString}}}
    await interactions.touchDown({{{x}}}, {{{y}}}).sleep({{{sleep}}});
      {{/touchDown}}
      {{#touchMove}}
    await interactions.touchMove({{{x}}}, {{{y}}}).sleep({{{sleep}}});
      {{/touchMove}}
      {{#touchUp}}
    await interactions.touchUp({{{x}}}, {{{y}}}).sleep({{{sleep}}});
      {{/touchUp}}
      {{#backButton}}
    // TF : {{{timeString}}}
    console.log("\nTF : Pressed back, time: {{{timeString}}}\n".magenta.underline);
    await interactions.back().sleep({{{sleep}}});
      {{/backButton}}
    {{/input}}
{{! ---------------------------------- }}
    {{#checkpoint}}
    // TF : {{{timeString}}}
    console.log("\nTF : {{{name}}}, time: {{{timeString}}}\n".magenta.underline);
    {{/checkpoint}}
{{! ---------------------------------- }}
    {{#userInteraction}}
      {{^viewId}}
        {{#accessibilityClassName}}
          {{#swipe}}
    // TF : {{timeString}}}
    console.log("\nTF : Swiped {{{label}}}, time: {{{timeString}}}\n".magenta.underline);
          {{/swipe}}
          {{#buttonPressed}}
    // TF : {{{timeString}}}
    console.log("\nTF : Clicked {{{label}}}, time: {{{timeString}}}\n".magenta.underline);
          {{/buttonPressed}}
          {{#buttonLongPressed}}
    // TF : {{{timeString}}}
    console.log("\nTF : Long pressed {{{label}}}, time: {{{timeString}}}\n".magenta.underline);
          {{/buttonLongPressed}}
          {{#buttonDoublePressed}}
    // TF : {{{timeString}}}
    console.log("\nTF : Double pressed {{{label}}}, time: {{{timeString}}}\n".magenta.underline);
          {{/buttonDoublePressed}}
    await interactions.findTextInView('{{{label}}}', '{{{className}}}')
        {{/accessibilityClassName}}
      {{/viewId}}
{{!   -------------------- }}
      {{#viewId}}
        {{#swipe}}
    // TF : {{{timeString}}}
    console.log("\nTF : Swiped id/{{{viewId}}}, time: {{{timeString}}}\n".magenta.underline);
        {{/swipe}}
        {{#buttonPressed}}
    // TF : {{{timeString}}}
    console.log("\nTF : Clicked id/{{{viewId}}}, time: {{{timeString}}}\n".magenta.underline);
        {{/buttonPressed}}
        {{#buttonLongPressed}}
    // TF : {{{timeString}}}
    console.log("\nTF : Long pressed id/{{{viewId}, time: {{{timeString}}}\n".magenta.underline);
        {{/buttonLongPressed}}
        {{#buttonDoublePressed}}
    // TF : {{{timeString}}}
    console.log("\nTF : Double pressed id/{{{viewId}, time: {{{timeString}}}\n".magenta.underline);
        {{/buttonDoublePressed}}
    await interactions.findViewById('{{{viewId}}}', '{{{label}}}', '{{{className}}}').click();
        {{#isEditTextFocusGain}}
    await interactions.insertText('{{{viewId}}}', 'EDITME'); // EDITME : Edit the string on the left or remove line if not relevant
        {{/isEditTextFocusGain}}
      {{/viewId}}
    {{/userInteraction}}
{{! ---------------------------------- }}
    {{#foregroundActivity}}
    // TF : {{{timeString}}}
    console.log("\nTF : In {{{name}}}, time: {{{timeString}}}\n".magenta.underline);
      {{#isLastActionBackButton}}
    await interactions.waitActivity('{{{name}}}', true);
      {{/isLastActionBackButton}}
      {{^isLastActionBackButton}}
    await interactions.waitActivity('{{{name}}}', false);
      {{/isLastActionBackButton}}
    {{/foregroundActivity}}

{{! Empty line for easy readability }}
  {{/testLines}}

    return tester.assert.isFulfilled(driver.sleep(5000));
  });
});
